{% extends "base.html" %}

{% block title %}
–ß–∞—Ç —Å {{recipient_value[0]}}
{% endblock %}

{% block message %}active{% endblock %} <!-- –ø–æ–¥—Å–≤–µ—Ç–∫–∞, —á—Ç–æ –º—ã –Ω–∞ –±–ª–æ–∫–µ —Å–æ–æ–±—â–µ–Ω–∏–π -->
{% block other_links%}
<script src="/static/assets/js/buffer.js"></script>
<script src="/static/assets/js/load_pem.js"></script>
<script src="/static/assets/js/decode.js"></script>
<script src="/static/assets/js/send-message.js"></script>
{%endblock%}
{% block main %}

<div class="content-page-box-area">
    <div class="all-messages-body">
        <div class="all-messages-header d-flex justify-content-between align-items-center">
            <h3>–ß–∞—Ç —Å {{recipient_value[0]}}</h3>
        </div>

        <div class="messages-profile-box">
            <a href="/profile/{{id_recipient}}"><img src="{{recipient_value[3]}}" height="100px" ; width="100px" ;
                    class="rounded-circle" alt="image"></a>
            <h3><a href="/profile/{{id_recipient}}">{{recipient_value[0]}}</a></h3>
        </div>

        <div class="messages-chat-container" id="test1">
            <div class="chat-content" id="test2">
                <div class="chat" id="chat-container">
                    <!-- —Ç—É—Ç —Å–æ–æ–±—â–µ–Ω–∏—è -->
                </div>

                <script>
                    let currentPage = 1;
                    let isLoading = false;
                    let firstLoad = true;
                    let hasMoreMessages = true;

                    const chatId = parseInt("{{ id_recipient }}");
                    const rowid = parseInt("{{ rowid }}");
                    const myAvatar = "{{ path }}";
                    const recipientAvatar = "{{ recipient_value[3].replace('\\', '/').strip() }}";

                    function generateMessageId() {
                        return 'msg-' + performance.now().toString(36).replace('.', '') +
                            '-' + Math.random().toString(36).substring(2, 9);
                    }

                    async function loadMessages(page = 1) {
                        if (isLoading || !hasMoreMessages) return;
                        isLoading = true;

                        const container = document.getElementById('chat-container');
                        if (!container) {
                            console.error('‚ùå –ö–æ–Ω—Ç–µ–π–Ω–µ—Ä #chat-container –Ω–µ –Ω–∞–π–¥–µ–Ω');
                            return;
                        }

                        const scrollBefore = container.scrollHeight;

                        try {
                            console.log(`üöÄ fetch –Ω–∞ /messages/${chatId}/data?page=${page}`);
                            const response = await fetch(`/messages/${chatId}/data?page=${page}`);

                            if (!response.ok) throw new Error(`HTTP error: ${response.status}`);

                            const messages = await response.json();
                            console.log(`‚úÖ –ü–æ–ª—É—á–µ–Ω–æ ${messages.length} —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–∞ page=${page}`);

                            if (!Array.isArray(messages) || messages.length === 0) {
                                console.log("‚ö†Ô∏è –ë–æ–ª—å—à–µ —Å–æ–æ–±—â–µ–Ω–∏–π –Ω–µ—Ç");
                                hasMoreMessages = false;
                                return;
                            }

                            if (messages.length < 10) {
                                hasMoreMessages = false;
                            }


                            const fragment = document.createDocumentFragment();
                            messages.reverse();
                            for (const message of messages) {
                                const messageId = generateMessageId();
                                const messageDiv = document.createElement('div');
                                messageDiv.className = `chat ${message.is_my ? 'chat-left' : ''}`;

                                const profileLink = message.is_my ? `/${rowid}` : `/${chatId}`;
                                const avatarSrc = message.is_my ? myAvatar : recipientAvatar;

                                const avatarHTML = `
                <div class="chat-avatar">
                    <a href="${profileLink}" class="d-inline-block">
                        <img src="${avatarSrc}" width="50" height="50" class="rounded-circle" alt="avatar">
                    </a>
                </div>`;

                                const spanText = document.createElement('span');
                                spanText.className = 'message-content';
                                spanText.innerText = '[–ó–∞–≥—Ä—É–∑–∫–∞...]';

                                const spanTime = document.createElement('span');
                                spanTime.className = 'time d-block';
                                spanTime.innerText = message.time;

                                const messageBody = document.createElement('div');
                                messageBody.className = 'chat-message';
                                messageBody.id = messageId;
                                messageBody.appendChild(spanText);
                                messageBody.appendChild(spanTime);

                                const bodyWrapper = document.createElement('div');
                                bodyWrapper.className = 'chat-body';
                                bodyWrapper.appendChild(messageBody);

                                messageDiv.innerHTML = avatarHTML;
                                messageDiv.appendChild(bodyWrapper);

                                fragment.appendChild(messageDiv);

                                try {
                                    const decryptedText = await decryptMessage(message.text || '');
                                    spanText.innerText = decryptedText;
                                } catch (err) {
                                    console.error("‚ùå –û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏:", err);
                                    spanText.innerText = '[–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]';
                                }
                            }

                            container.prepend(fragment);

                            if (firstLoad) {
                                requestAnimationFrame(() => {
                                    container.scrollTop = container.scrollHeight;
                                    setTimeout(() => {
                                        if (container.scrollTop !== container.scrollHeight) {
                                            container.scrollTop = container.scrollHeight;
                                        }
                                    }, 100);
                                    firstLoad = false;
                                });
                            } else {
                                const scrollDiff = container.scrollHeight - scrollBefore;
                                container.scrollTop += scrollDiff;
                            }

                        } catch (error) {
                            console.error('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                        } finally {
                            isLoading = false;
                        }
                    }

                    function forceScrollToBottom() {
                        const container = document.getElementById('chat-container');
                        if (container) {
                            container.scrollTop = container.scrollHeight;
                            setTimeout(() => {
                                container.scrollTop = container.scrollHeight;
                            }, 300);
                        }
                    }

                    document.addEventListener('DOMContentLoaded', () => {
                        console.log("‚úÖ DOM –∑–∞–≥—Ä—É–∂–µ–Ω, –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è");

                        const chatContainer = document.getElementById('chat-container');
                        if (!chatContainer) {
                            console.error("‚ùå –≠–ª–µ–º–µ–Ω—Ç #chat-container –Ω–µ –Ω–∞–π–¥–µ–Ω");
                            return;
                        }

                        chatContainer.style.height = '90vh';
                        chatContainer.style.overflowY = 'auto';

                        window.addEventListener('load', forceScrollToBottom);

                        loadMessages(currentPage);

                        chatContainer.addEventListener('scroll', () => {
                            if (chatContainer.scrollTop < 100 && !isLoading && hasMoreMessages) {
                                currentPage++;
                                console.log(`üì• –ó–∞–≥—Ä—É–∂–∞–µ–º page=${currentPage}`);
                                loadMessages(currentPage);
                            }
                        });
                    });
                </script>




                <div class="chat-list-footer">
                    <form class="d-flex align-items-center">
                        <div class="btn-box d-flex align-items-center me-3">
                            <button class="file-attachment-btn d-inline-block me-2" data-bs-toggle="tooltip"
                                data-bs-placement="top" title="File Attachment" type="button"><i
                                    class="ri-attachment-2"></i></button>

                            <button class="emoji-btn d-inline-block" data-bs-toggle="tooltip" data-bs-placement="top"
                                title="Emoji" type="button"><i class="ri-user-smile-line"></i></button>
                        </div>

                        <input type="text" class="form-control" id="sendMessageToServer"
                            placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." maxlength="80" required>
                        <button type="button" class="send-btn d-inline-block" data-user-id="{{id_recipient}}"
                            onclick="saveInput({{id_recipient}})">–ü–æ—Å–ª–∞—Ç—å</button>
                    </form>
                </div>
            </div>
        </div>
    </div>

</div>
<script src="/static/assets/js/keys_generate.js"></script>
<script>
    window.onload = async function () {
        console.log("–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞, –ø—Ä–æ–≤–µ—Ä—è–µ–º –∫–ª—é—á–∏...");
        const not_key = {{ not_key | tojson
    }};
    if (not_key == 1) {
        console.log("–ö–ª—é—á–∏ —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã.");
        await generateAndSaveKeys(rowid);
        window.location.reload();
    } else {
        console.log("–ü–∞—Ä–∞ –∫–ª—é—á–µ–π —É–∂–µ –µ—Å—Ç—å.");
    }
};
</script>
<script>
    document.addEventListener("DOMContentLoaded", () => {
        const chatId = parseInt("{{ id_recipient }}"); 
        const rowid = parseInt("{{ rowid }}");        
        const username = "{{ request.session.user_data.name if request.session.user_data is defined else '' }}"; 

        const roomId = Math.min(chatId, rowid) + "_" + Math.max(chatId, rowid); 

        const protocol = window.location.protocol === "https:" ? "wss://" : "ws://";
        const ws = new WebSocket(`${protocol}${window.location.host}/messages/ws/${roomId}/${encodeURIComponent(username)}/${rowid}`);

        ws.onopen = () => console.log("WS connected");
        ws.onmessage = async (event) => {
            try {
                const msg = JSON.parse(event.data);

                const container = document.getElementById('chat-container');
                if (!container) return;

                const messageId = generateMessageId();
                const messageDiv = document.createElement('div');
                messageDiv.className = `chat ${msg.is_self ? 'chat-left' : ''}`;

                const profileLink = msg.is_self ? `/${rowid}` : `/${chatId}`;
                const avatarSrc = msg.is_self ? myAvatar : recipientAvatar;

                const avatarHTML = `
            <div class="chat-avatar">
                <a href="${profileLink}" class="d-inline-block">
                    <img src="${avatarSrc}" width="50" height="50" class="rounded-circle" alt="avatar">
                </a>
            </div>`;

                const spanText = document.createElement('span');
                spanText.className = 'message-content';
                spanText.innerText = '[–ó–∞–≥—Ä—É–∑–∫–∞...]';

                const spanTime = document.createElement('span');
                spanTime.className = 'time d-block';
                spanTime.innerText = (new Date()).toLocaleString();

                const messageBody = document.createElement('div');
                messageBody.className = 'chat-message';
                messageBody.id = messageId;
                messageBody.appendChild(spanText);
                messageBody.appendChild(spanTime);

                const bodyWrapper = document.createElement('div');
                bodyWrapper.className = 'chat-body';
                bodyWrapper.appendChild(messageBody);

                messageDiv.innerHTML = avatarHTML;
                messageDiv.appendChild(bodyWrapper);

                container.appendChild(messageDiv);

                if (msg.encrypted) {
                    try {
                        const decrypted = await decryptMessage(msg.text || "");
                        spanText.innerText = decrypted;
                    } catch (e) {
                        console.error("–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏ WS:", e);
                        spanText.innerText = "[–û—à–∏–±–∫–∞ —Ä–∞—Å—à–∏—Ñ—Ä–æ–≤–∫–∏]";
                    }
                } else {
                    spanText.innerText = msg.text || "";
                }

                container.scrollTop = container.scrollHeight;

            } catch (e) {
                console.error("–û—à–∏–±–∫–∞ –≤ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–µ WS:", e, event.data);
            }
        };

        ws.onclose = () => console.log("WS closed");
    });
</script>


{% endblock %}