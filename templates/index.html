{% extends "base.html" %}

{% block title %}Главная страница{% endblock %}
{% block tape %}active{% endblock %}

{% block main %}
<div class="content-page-box-area">
  <div class="row">
    <div class="col-lg-3 col-md-12">
      <aside class="widget-area">
        <div class="widget widget-view-profile">
          <div class="profile-box d-flex justify-content-between align-items-center">
            <a href="/profile/{{ rowid }}"><img src="{{ path_user }}" alt="avatar"></a>
            <div class="text ms-2">
              <h3><a href="" onclick="return false;">{{ name_user }}</a></h3>
              <span>{{ login_user }}</span>
            </div>
          </div>
          <ul class="profile-statistics">
            <li>
              <a href="" onclick="return false;">
                <span class="item-number">{{ score_like_user }}</span>
                <span class="item-text">Лайков</span>
              </a>
            </li>

            <li>
              <a href="" onclick="return false;">
                <span class="item-number">{{ score_sub_user }}</span>
                <span class="item-text">Подписок</span>
              </a>
            </li>
          </ul>
          <div class="profile-btn">
            <a href="/profile/{{ rowid }}" class="default-btn">Профиль</a>
          </div>
        </div>
      </aside>
    </div>

    <div class="col-lg-6 col-md-12">
      <div class="news-feed-area">
        <!-- посты -->
      </div>

      <div class="load-more-posts-btn text-center w-100 mt-3">
        <a href="#" onclick="return false;"><i class="flaticon-loading"></i> Загрузка...</a>
      </div>
    </div>


  </div>
</div>
{% endblock %}

{% block other_links_bottom %}
<script src="/static/assets/js/edit-delete-post.js"></script>
<script src="/static/assets/js/like-and-sub.js"></script>

<script>window.csrfToken = "{{ csrf_token }}";</script>

<script>
  (function () {
    'use strict';

    function renderFeedPost(post, index) {
      const avatar = post.avatar || '/static/assets/images/my-profile.jpg';
      const name = post.name || 'User';
      const login = post.login || '';
      const text = (typeof post.text !== 'undefined') ? String(post.text).replace(/\n/g, "<br>") : "";
      const likes = (typeof post.likes !== 'undefined') ? post.likes : 0;
      const liked = !!post.liked_by_viewer;
      const csrf = window.csrfToken || "";

      const formId = `likeForm-${post.post_id}`;

      return `
  <div class="news-feed news-feed-post" id="post-${post.post_id}">
    <div class="post-header d-flex justify-content-between align-items-center">
      <div class="image">
        <a href="/profile/${post.who}">
          <img src="${avatar}" style="width: 55px; height: 55px" class="rounded-circle" alt="avatar">
        </a>
      </div>
      <div class="info ms-3">
        <span class="name"><a href="/profile/${post.who}">${name}</a></span>
        <span class="small-text"><a href="mailto:${login}">${login}</a></span>
      </div>
    </div>
    <div class="post-body">
      <p>${text}</p>
      <ul class="post-meta-wrap d-flex justify-content-between align-items-center">
        <form id="${formId}" action="/profile/like-post" method="POST">
          <li class="post-react">
            <input type="hidden" name="post_id" value="${post.post_id}">
            <input type="hidden" name="csrf_token" value="${csrf}">
            <a href="#" class="like-button" data-form-id="${formId}">
              <i class="flaticon-like"></i>
              <span class="label" ${liked ? 'style="color: #3644D9;"' : ''}>Лайков</span>
              <span class="number" ${liked ? 'style="color: #3644D9;"' : ''}>${likes}</span>
            </a>
          </li>
        </form>
        <li class="post-share">
          <a href="#" onclick="return false;">
            <i class="flaticon-calendar"></i>
            <span>Дата публикации</span>
            <span class="number">${post.timestamp || ''}</span>
          </a>
        </li>
      </ul>
    </div>
  </div>`.trim();
    }


    document.addEventListener('DOMContentLoaded', () => {
      const feedArea = document.querySelector('.col-lg-6 .news-feed-area') || document.querySelector('.news-feed-area');
      if (!feedArea) return;

      const col = feedArea.closest('.col-lg-6') || feedArea.parentElement;
      const loader = col.querySelector('.load-more-posts-btn');
      if (!loader) return;

      let offset = 0;
      const limit = 5;
      let loading = false;
      let allLoaded = false;

      async function loadMore() {
        if (loading || allLoaded) return;
        loading = true;
        loader.style.display = 'block';

        try {
          const resp = await fetch(`/load-feed?offset=${offset}&limit=${limit}`);
          if (!resp.ok) throw new Error('HTTP ' + resp.status);
          const data = await resp.json();
          const posts = data.posts || [];

          if (!Array.isArray(posts) || posts.length === 0) {
            allLoaded = true;
            loader.innerHTML = '<span>Больше нет</span>';
            return;
          }

          let added = 0;
          posts.forEach((post, i) => {
            if (feedArea.querySelector(`#post-${post.post_id}`)) return;
            const html = renderFeedPost(post, offset + i);
            const frag = document.createRange().createContextualFragment(html);
            feedArea.appendChild(frag);
            added++;
          });

          offset += posts.length;

          if (posts.length < limit || added === 0) {
            allLoaded = true;
            loader.innerHTML = '<span>Больше нет</span>';
          }
        } catch (err) {
          console.error('Ошибка загрузки ленты:', err);
          loader.innerHTML = '<span>Ошибка загрузки</span>';
        } finally {
          loading = false;
          if (allLoaded) loader.style.display = 'none';
        }
      }

      const io = new IntersectionObserver(entries => {
        entries.forEach(ent => {
          if (ent.isIntersecting) loadMore();
        });
      }, { root: null, rootMargin: '400px', threshold: 0.1 });

      io.observe(loader);

      loadMore();
    });
  })();
</script>
{% endblock %}